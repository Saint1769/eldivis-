<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* –û–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        #registration-window {
            padding: 40px;
            text-align: center;
        }

        #registration-window h2 {
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #888;
            font-size: 12px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a6fd8;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ */
        #main-window {
            display: none;
            height: 80vh;
        }

        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .user-profile {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #34495e;
        }

        .status-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            background: #34495e;
            color: white;
            border: none;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-section h4 {
            margin-bottom: 10px;
        }

        .search-box {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            border: none;
        }

        #search-results .user-result {
            background: #34495e;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }

        #search-results .user-result:hover {
            background: #3d566e;
        }

        .online-users {
            margin-top: 20px;
        }

        .online-users h4 {
            margin-bottom: 10px;
        }

        #users-list .user-item {
            padding: 8px;
            margin: 5px 0;
            background: #34495e;
            border-radius: 5px;
            cursor: pointer;
        }

        #users-list .user-item:hover {
            background: #3d566e;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #3498db;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-tabs {
            display: flex;
            background: #ecf0f1;
            padding: 0 20px;
            border-bottom: 1px solid #bdc3c7;
            flex-wrap: wrap;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-button.private-tab {
            background: #e74c3c;
            color: white;
            margin: 2px;
            border-radius: 5px 5px 0 0;
        }

        .messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-tab {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .chat-tab.active {
            display: flex;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 70%;
        }

        .message.own {
            background: #3498db;
            color: white;
            margin-left: auto;
        }

        .message.other {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .message.private {
            border-left: 4px solid #e74c3c;
        }

        .message.system {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            background: #f8f9fa;
            max-width: 100%;
        }

        .message-info {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .message-input {
            display: flex;
            padding: 20px;
            background: #ecf0f1;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }

        .connected {
            background: #2ecc71;
            color: white;
        }

        .disconnected {
            background: #e74c3c;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                height: 100vh;
            }
            
            #main-window {
                flex-direction: column;
                height: 100vh;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
            }
            
            .main-content {
                height: 60%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="connection-status" class="connection-status disconnected">
            üî¥ –û—Ç–∫–ª—é—á–µ–Ω
        </div>

        <!-- –û–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="registration-window">
            <h2>üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —á–∞—Ç–µ</h2>
            <div class="form-group">
                <label>üë§ –Æ–∑–µ—Ä–Ω–µ–π–º (–¥–ª—è –ø–æ–∏—Å–∫–∞):</label>
                <input type="text" id="username-input" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —é–∑–µ—Ä–Ω–µ–π–º" maxlength="20">
                <small>–ü–æ —ç—Ç–æ–º—É –∏–º–µ–Ω–∏ –≤–∞—Å —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</small>
            </div>
            <div class="form-group">
                <label>üé≠ –ù–∏–∫–Ω–µ–π–º (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è):</label>
                <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º –≤ —á–∞—Ç–µ" maxlength="20">
                <small>–≠—Ç–æ –∏–º—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</small>
            </div>
            <button id="register-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</button>
        </div>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
        <div id="main-window">
            <div class="sidebar">
                <div class="user-profile">
                    <h3 id="current-user">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
                    <div class="status-selector">
                        <select id="status-select">
                            <option value="online">üü¢ Online</option>
                            <option value="away">üü° Away</option>
                            <option value="dnd">üî¥ Do Not Disturb</option>
                        </select>
                    </div>
                </div>
                
                <div class="search-section">
                    <h4>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4>
                    <div class="search-box">
                        <input type="text" id="user-search" placeholder="–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º">
                        <button id="search-btn">–ù–∞–π—Ç–∏</button>
                    </div>
                    <div id="search-results"></div>
                </div>

                <div class="online-users">
                    <h4>üë• –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
                    <div id="users-list"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="chat-header">
                    <h2>üí¨ Real-time Chat</h2>
                </div>
                
                <div class="chat-tabs">
                    <button class="tab-button active" data-tab="global">üåê –û–±—â–∏–π —á–∞—Ç</button>
                    <div id="private-tabs"></div>
                </div>
                
                <div class="messages-container">
                    <div id="global-chat" class="chat-tab active">
                        <div id="global-messages" class="messages"></div>
                        <div class="message-input">
                            <input type="text" id="global-message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                            <button id="global-send-btn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div id="private-chats"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É Socket.IO
        const socket = io('wss://socket-io-chat-haxy.onrender.com', {
            transports: ['websocket', 'polling']
        });

        let currentUser = null;
        let activePrivateChats = new Set();

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const registrationWindow = document.getElementById('registration-window');
        const mainWindow = document.getElementById('main-window');
        const usernameInput = document.getElementById('username-input');
        const nicknameInput = document.getElementById('nickname-input');
        const registerBtn = document.getElementById('register-btn');
        const userSearch = document.getElementById('user-search');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');
        const usersList = document.getElementById('users-list');
        const statusSelect = document.getElementById('status-select');
        const connectionStatus = document.getElementById('connection-status');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        socket.on('connect', () => {
            console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            connectionStatus.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            connectionStatus.className = 'connection-status connected';
        });

        socket.on('disconnect', () => {
            console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            connectionStatus.textContent = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ';
            connectionStatus.className = 'connection-status disconnected';
        });

        socket.on('connect_error', (error) => {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
            connectionStatus.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            connectionStatus.className = 'connection-status disconnected';
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        registerBtn.addEventListener('click', registerUser);
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') registerUser();
        });
        nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') registerUser();
        });

        function registerUser() {
            const username = usernameInput.value.trim();
            const nickname = nicknameInput.value.trim();

            if (username && nickname) {
                registerBtn.disabled = true;
                registerBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                socket.emit('register_user', { username, nickname });
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        searchBtn.addEventListener('click', searchUser);
        userSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchUser();
        });

        function searchUser() {
            const searchUsername = userSearch.value.trim();
            if (searchUsername) {
                socket.emit('search_user', searchUsername, (user) => {
                    displaySearchResult(user, searchUsername);
                });
            }
        }

        function displaySearchResult(user, searchedUsername) {
            searchResults.innerHTML = '';
            
            if (user) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'user-result';
                resultDiv.innerHTML = `
                    <strong>${user.nickname}</strong> (@${user.username})
                    <br><small>–°—Ç–∞—Ç—É—Å: ${getStatusText(user.status)}</small>
                    <br><button onclick="startPrivateChat('${user.username}')">üíå –ù–∞–ø–∏—Å–∞—Ç—å</button>
                `;
                searchResults.appendChild(resultDiv);
            } else {
                searchResults.innerHTML = `<div class="user-result">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @${searchedUsername} –Ω–µ –Ω–∞–π–¥–µ–Ω</div>`;
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'online': 'üü¢ Online',
                'away': 'üü° Away',
                'dnd': 'üî¥ Do Not Disturb',
                'offline': '‚ö´ Offline'
            };
            return statusMap[status] || status;
        }

        // –ù–∞—á–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
        window.startPrivateChat = function(username) {
            if (!activePrivateChats.has(username)) {
                createPrivateChatTab(username);
                activePrivateChats.add(username);
            }
            switchTab(username);
        }

        function createPrivateChatTab(username) {
            // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É
            const tabButton = document.createElement('button');
            tabButton.className = 'tab-button private-tab';
            tabButton.dataset.tab = username;
            tabButton.textContent = `üí¨ ${username}`;
            tabButton.onclick = () => switchTab(username);
            
            document.getElementById('private-tabs').appendChild(tabButton);

            // –°–æ–∑–¥–∞–µ–º –æ–∫–Ω–æ —á–∞—Ç–∞
            const chatDiv = document.createElement('div');
            chatDiv.id = `chat-${username}`;
            chatDiv.className = 'chat-tab';
            chatDiv.innerHTML = `
                <div id="messages-${username}" class="messages"></div>
                <div class="message-input">
                    <input type="text" id="input-${username}" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è @${username}..." maxlength="500">
                    <button onclick="sendPrivateMessage('${username}')">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            `;
            
            document.getElementById('private-chats').appendChild(chatDiv);
        }

        function switchTab(tabName) {
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-button').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.chat-tab').forEach(tab => tab.classList.remove('active'));
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            const chatElement = document.getElementById(tabName === 'global' ? 'global-chat' : `chat-${tabName}`);
            if (chatElement) {
                chatElement.classList.add('active');
                
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º input –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
                const inputId = tabName === 'global' ? 'global-message-input' : `input-${tabName}`;
                const inputElement = document.getElementById(inputId);
                if (inputElement) {
                    inputElement.focus();
                }
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        document.getElementById('global-send-btn').addEventListener('click', sendGlobalMessage);
        document.getElementById('global-message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendGlobalMessage();
        });

        function sendGlobalMessage() {
            const input = document.getElementById('global-message-input');
            const message = input.value.trim();
            
            if (message && currentUser) {
                socket.emit('send_message', { message });
                input.value = '';
            }
        }

        window.sendPrivateMessage = function(toUsername) {
            const input = document.getElementById(`input-${toUsername}`);
            const message = input.value.trim();
            
            if (message) {
                socket.emit('send_private_message', {
                    toUsername: toUsername,
                    message: message
                });
                input.value = '';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Socket.IO
        socket.on('registration_success', (userInfo) => {
            currentUser = userInfo;
            registrationWindow.style.display = 'none';
            mainWindow.style.display = 'flex';
            document.getElementById('current-user').textContent = `${userInfo.nickname} (@${userInfo.username})`;
        });

        socket.on('registration_error', (error) => {
            alert(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error}`);
            registerBtn.disabled = false;
            registerBtn.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É';
        });

        socket.on('user_online', (userInfo) => {
            addSystemMessage(`üü¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userInfo.nickname} (@${userInfo.username}) –æ–Ω–ª–∞–π–Ω`);
        });

        socket.on('user_offline', (userInfo) => {
            addSystemMessage(`‚ö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userInfo.nickname} (@${userInfo.username}) –æ—Ñ—Ñ–ª–∞–π–Ω`);
        });

        socket.on('receive_message', (messageData) => {
            addGlobalMessage(messageData, messageData.username === currentUser?.username);
        });

        socket.on('receive_private_message', (messageData) => {
            const { from, fromNickname, message, timestamp } = messageData;
            
            // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            if (!activePrivateChats.has(from)) {
                startPrivateChat(from);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const messagesContainer = document.getElementById(`messages-${from}`);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message private ${from === currentUser?.username ? 'own' : 'other'}`;
            messageDiv.innerHTML = `
                <div class="message-info">üí¨ ${fromNickname} (@${from}) ‚Ä¢ ${timestamp}</div>
                <div class="message-text">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        socket.on('online_users_update', (users) => {
            usersList.innerHTML = '';
            users.forEach(user => {
                if (user.username !== currentUser?.username) {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    userDiv.innerHTML = `
                        <strong>${user.nickname}</strong> (@${user.username})
                        <br><small>${getStatusText(user.status)}</small>
                    `;
                    userDiv.onclick = () => startPrivateChat(user.username);
                    usersList.appendChild(userDiv);
                }
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        statusSelect.addEventListener('change', (e) => {
            socket.emit('update_status', e.target.value);
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function addGlobalMessage(messageData, isOwn = false) {
            const messagesContainer = document.getElementById('global-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            messageDiv.innerHTML = `
                <div class="message-info">${messageData.username} ‚Ä¢ ${messageData.timestamp}</div>
                <div class="message-text">${messageData.message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const messagesContainer = document.getElementById('global-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                switchTab(e.target.dataset.tab);
            });
        });

        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        usernameInput.focus();
    </script>
</body>
</html>